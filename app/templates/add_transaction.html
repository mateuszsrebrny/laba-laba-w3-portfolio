{% extends "base.html" %}
{% block content %}
    <h2>Add Transaction</h2>
    <div id="message" class="text-danger mb-2"></div>

    <script>
        function showMessage(message, type) {
            const messageContainer = document.getElementById('message');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        
            messageContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
        
            // Automatically hide the message after 5 seconds
            setTimeout(() => {
                messageContainer.style.transition = "opacity 1s";
                messageContainer.style.opacity = "0"; // Fade out
                setTimeout(() => {
                    messageContainer.innerHTML = ""; // Clear content after fade-out
                    messageContainer.style.opacity = "1"; // Reset opacity for future messages
                }, 1000); // Wait for fade-out duration (1 second)
            }, 5000); // Adjust timeout duration as needed
        }

        document.addEventListener('htmx:afterRequest', function (event) {
            const xhr = event.detail.xhr;
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.status === 'success') {
                    showMessage(response.message, 'success');
                
                    if (event.target.id === "transaction-form") {
                        // Reset all input fields in the form.
                        event.target.reset();

                        // Additionally, clear the flatpickr instance on the #timestamp input if it's active.
                        const ts = event.target.querySelector("#timestamp");
                        if (ts && ts._flatpickr) {
                            //ts._flatpickr.clear();
                            ts._flatpickr.setDate(new Date(), true);
                        }
                    }	

				}
            }
        });

        document.addEventListener('htmx:responseError', function (event) {
            const xhr = event.detail.xhr;
            let errorMessage = "An unknown error occurred.";
            if (xhr.status >= 400 && xhr.status < 500) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.error || errorMessage; // Extract error message from response
                } catch (e) {
                    console.error("Failed to parse error response:", e);
                }
            }
            showMessage(errorMessage, 'danger');
        });

        // Reinitialize flatpickr after HTMX loads the transaction form.
        document.body.addEventListener("htmx:afterSwap", function(event) {
            if (event.detail.target.id === "transaction-form-container") {
                flatpickr("#timestamp", {
                    enableTime: true,
                    enableSeconds: true,
                    time_24hr: true,
                    dateFormat: "Y-m-d H:i:S",
                    defaultDate: document.getElementById("timestamp").value
                });
            }
        });

    </script>

    <div id="transaction-form-container" 
        hx-get="/ui/transactions/form" 
        hx-trigger="load">
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        flatpickr("#timestamp", {
            enableTime: true,
            enableSeconds: true,
            time_24hr: true,
            dateFormat: "Y-m-d H:i:S",
            defaultDate: "{{ now|datetimeformat }}"
            //defaultDate: new Date().toISOString().slice(0, 19)
        });
    </script>
{% endblock %}
