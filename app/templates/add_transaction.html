{% extends "base.html" %}
{% block content %}
    <h2>Add Transaction</h2>
    <div id="error" class="text-danger mb-2"></div>

    <script>
        function showErrorMessage(xhr) {
            const errorContainer = document.getElementById('error');
            let errorMessage = "An unknown error occurred."; 

            if (xhr.status >= 400 && xhr.status < 500) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    // Extract error message from response
                    errorMessage = response.error || errorMessage; 
                } catch (e) {
                    console.error("Failed to parse error response:", e);
                }
            }

            // Display the error message
            errorContainer.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;

            // Automatically hide the error message after 5 seconds with fade-out effect
            setTimeout(() => {
                errorContainer.style.transition = "opacity 1s";
                errorContainer.style.opacity = "0"; // Fade out
                setTimeout(() => {
                    errorContainer.innerHTML = ""; // Clear content after fade-out
                    errorContainer.style.opacity = "1"; // Reset opacity for future messages
                }, 1000); // Wait for fade-out duration (1 second)
            }, 5000); // Adjust timeout duration as needed
        }

        // HTMX event listener for response errors
        document.addEventListener('htmx:responseError', function (event) {
            showErrorMessage(event.detail.xhr);
        });
    </script>

    <form hx-post="/add" hx-target="#transaction-list" hx-indicator="#loading" hx-swap="beforeend">


        <div id="loading" class="htmx-indicator">Submitting...</div>
        <div id="transaction-list"></div>
        <label>Amount:</label>
        <input type="text" name="amount" required class="form-control">
        
        <label>Token:</label>
        <input type="text" name="token" required class="form-control">

        <label>Timestamp:</label>
        <input 
            id="timestamp"
            type="text" 
            name="timestamp" 
            required class="form-control"
            step="1"
            value="{{ now|datetimeformat }}"
        >

        <button type="submit" class="btn btn-success mt-2">Submit</button>
    </form>

    <a href="/" class="btn btn-secondary mt-2">Back to Transactions</a>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script>
	flatpickr("#timestamp", {
	  enableTime: true,
	  enableSeconds: true,
	  time_24hr: true,
	  dateFormat: "Y-m-d\\TH:i:S",
	  defaultDate: new Date().toISOString().slice(0, 19)
	});
	</script>
{% endblock %}
